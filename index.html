<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Maquipan - Sistema de Gestión</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome para iconos -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="css/styles.css">
    <!-- SweetAlert2 para las notificaciones -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- SheetJS para Excel -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">
                <div class="logo-m">M</div>
                <div class="logo-text">MAQUIPAN</div>
                <div class="logo-subtitle">SERVICIO TÉCNICO</div>
            </div>
            <nav class="nav-menu">
                <a onclick="router.navigate('dashboard')" class="nav-link active">HOME</a>
                <a onclick="router.navigate('requerimientos')" class="nav-link">REQUERIMIENTOS</a>
                <a onclick="router.navigate('cotizaciones')" class="nav-link">COTIZACIONES</a>
                <a onclick="router.navigate('clientes')" class="nav-link">CLIENTES</a>
                <!-- Agregar este enlace para repuestos -->
                <a onclick="router.navigate('repuestos')" class="nav-link">REPUESTOS</a>
                <a onclick="router.navigate('busqueda')" class="nav-link">BÚSQUEDA</a>
                <a onclick="auth.logout()" class="nav-link">SALIR</a>
            </nav>
        </div>
    </header>
    <div class="user-section">
        <div class="user-info" id="userInfo">
            <!-- Nombre de usuario se carga dinámicamente -->
        </div>
    </div>
    <main class="main-container">
        <aside class="sidebar">
            <ul class="sidebar-menu">
                <li><a onclick="router.navigate('nuevo-requerimiento')" class="sidebar-link">NUEVO REQUERIMIENTO</a></li>
                <li><a onclick="router.navigate('nueva-cotizacion')" class="sidebar-link">NUEVA COTIZACIÓN</a></li>
                <li><a onclick="router.navigate('nuevo-cliente')" class="sidebar-link">NUEVO CLIENTE</a></li>
                <!-- Agregar este enlace en la barra lateral -->
                <li><a onclick="router.navigate('repuestos')" class="sidebar-link">GESTIÓN DE REPUESTOS</a></li>
                <li><a onclick="router.navigate('reportes')" class="sidebar-link">REPORTES</a></li>
                <li><a onclick="router.navigate('configuracion')" class="sidebar-link">CONFIGURACIÓN</a></li>
            </ul>
        </aside>
        <div class="main-content" id="app">
            <!-- El contenido se carga dinámicamente aquí -->
        </div>
    </main>
    
    <!-- Bootstrap JavaScript Bundle con Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- Librería para generar PDFs - DEBE IR ANTES DE TUS SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Tus scripts en el orden correcto -->
    <script src="js/services/firebase-config.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/router.js"></script>
    <script src="js/components/dashboard.js"></script>
    <script src="js/components/requerimientos.js"></script>
    <script src="js/components/cotizaciones.js"></script>
    <script src="js/components/clientes.js"></script>
    <script src="js/components/busqueda.js"></script>
    <script src="js/components/locales.js"></script>
    <script src="js/components/repuestos.js"></script>
    <script src="js/components/nuevo-cliente.js"></script>
    <!-- IMPORTANTE: Agregar el generador de PDF -->
    <script src="js/components/pdf-generator.js"></script>
    <!-- La aplicación principal DEBE ir al final -->
    <script src="js/app.js"></script>

    <!-- Opcional: Agregar un favicon para evitar errores 404 -->
    <link rel="icon" href="favicon.ico" type="image/x-icon">

    <!-- Sistema de recuperación de UI -->
    <div id="emergencyReset" style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; display: none;">
        <button onclick="window.emergencyResetUI()" class="btn btn-danger">
            <i class="fas fa-exclamation-triangle"></i> Reiniciar UI
        </button>
    </div>

    <!-- Script para recuperar UI bloqueada -->
    <script>
    // Sistema de recuperación de UI bloqueada
    (function() {
        // Funciones globales para resetear la UI
        window.emergencyResetUI = function() {
            console.log('Ejecutando recuperación de emergencia de la UI');
            
            // Cerrar todos los modales
            try {
                var modals = document.querySelectorAll('.modal');
                modals.forEach(function(modal) {
                    try {
                        if (typeof bootstrap !== 'undefined') {
                            var modalInstance = bootstrap.Modal.getInstance(modal);
                            if (modalInstance) {
                                modalInstance.hide();
                            }
                        }
                        // Fallback si bootstrap no está disponible
                        modal.style.display = 'none';
                        modal.classList.remove('show');
                        modal.setAttribute('aria-hidden', 'true');
                        modal.removeAttribute('aria-modal');
                    } catch(e) {
                        console.error('Error al cerrar modal:', e);
                    }
                });
            
                // Remover backdrops
                document.querySelectorAll('.modal-backdrop').forEach(e => e.remove());
                document.body.classList.remove('modal-open');
                document.body.style.overflow = '';
            } catch(e) {
                console.error('Error al limpiar modales:', e);
            }
            
            // Ocultar botón de emergencia
            document.getElementById('emergencyReset').style.display = 'none';
            
            // Recargar componente actual o ir al dashboard
            if (typeof router !== 'undefined') {
                try {
                    const currentRoute = window.location.hash.slice(1) || 'dashboard';
                    router.navigate(currentRoute);
                } catch(e) {
                    console.error('Error al navegar:', e);
                    // Si falla la navegación, recargar la página como último recurso
                    if (confirm('¿Deseas recargar la página completa?')) {
                        window.location.reload();
                    }
                }
            }
        };
        
        // Detectar posibles bloqueos de UI
        let uiBlockDetector = {
            lastActivity: Date.now(),
            checkInterval: null,
            
            init: function() {
                // Registrar interacciones del usuario
                document.addEventListener('click', () => this.resetTimer());
                document.addEventListener('mousemove', () => this.resetTimer());
                document.addEventListener('keypress', () => this.resetTimer());
                
                // Detectar cuando se abre un modal
                document.addEventListener('shown.bs.modal', () => {
                    this.resetTimer();
                    this.startMonitoring();
                });
                
                // Detectar cuando se cierra un modal normalmente
                document.addEventListener('hidden.bs.modal', () => {
                    this.stopMonitoring();
                });
                
                // Mostrar botón de emergencia con Ctrl+Alt+R
                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey && e.altKey && e.key === 'r') {
                        document.getElementById('emergencyReset').style.display = 'block';
                    }
                });
            },
            
            resetTimer: function() {
                this.lastActivity = Date.now();
            },
            
            startMonitoring: function() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                }
                
                this.checkInterval = setInterval(() => {
                    // Si hay un modal visible y no ha habido actividad en 15 segundos
                    const modalVisible = document.querySelector('.modal.show');
                    if (modalVisible && (Date.now() - this.lastActivity > 15000)) {
                        console.warn('Posible UI bloqueada detectada - Mostrando botón de emergencia');
                        document.getElementById('emergencyReset').style.display = 'block';
                    }
                }, 5000); // Revisar cada 5 segundos
            },
            
            stopMonitoring: function() {
                if (this.checkInterval) {
                    clearInterval(this.checkInterval);
                    this.checkInterval = null;
                }
            }
        };
        
        // Inicializar detector de bloqueos cuando el DOM esté listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => uiBlockDetector.init());
        } else {
            uiBlockDetector.init();
        }
    })();
    </script>

    <!-- Sistema de gestión segura de modales para toda la aplicación -->
    <script>
    (function() {
        // Función global para mostrar modales de forma segura
        window.mostrarModalSeguro = function(modalId) {
            try {
                console.log('Mostrando modal de forma segura:', modalId);
                
                // Limpiar cualquier modal previo
                window.limpiarUIBloqueada();
                
                const modalElement = document.getElementById(modalId);
                if (!modalElement) {
                    console.error(`Modal ${modalId} no encontrado`);
                    return null;
                }
                
                // Usar Bootstrap para mostrar el modal
                const modal = new bootstrap.Modal(modalElement, {
                    backdrop: 'static',
                    keyboard: true
                });
                
                modal.show();
                return modal;
            } catch (error) {
                console.error('Error al mostrar modal:', error);
                window.limpiarUIBloqueada();
                return null;
            }
        };

        // Función global para cerrar modales de forma segura
        window.cerrarModalSeguro = function(modalId) {
            try {
                console.log('Cerrando modal:', modalId);
                
                const modalElement = document.getElementById(modalId);
                if (!modalElement) {
                    console.error(`Modal ${modalId} no encontrado`);
                    return false;
                }
                
                // Intentar obtener la instancia de Bootstrap
                let modal = bootstrap.Modal.getInstance(modalElement);
                
                if (modal) {
                    modal.hide();
                } else {
                    // Fallback si no se puede obtener la instancia
                    modalElement.style.display = 'none';
                    modalElement.classList.remove('show');
                    window.limpiarUIBloqueada();
                }
                
                return true;
            } catch (error) {
                console.error('Error al cerrar modal:', error);
                window.limpiarUIBloqueada();
                return false;
            }
        };

        // Función global para limpiar UI bloqueada
        window.limpiarUIBloqueada = function() {
            console.log('Limpiando UI bloqueada');
            
            // Cerrar todos los modales
            document.querySelectorAll('.modal').forEach(modal => {
                try {
                    modal.style.display = 'none';
                    modal.classList.remove('show');
                    modal.setAttribute('aria-hidden', 'true');
                    modal.removeAttribute('aria-modal');
                } catch (e) {
                    console.error('Error al cerrar modal:', e);
                }
            });
            
            // Remover backdrops
            document.querySelectorAll('.modal-backdrop').forEach(e => e.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
        };

        // Interceptar eventos de clic para botones de modal
        document.addEventListener('click', function(event) {
            // Detectar botones que abren modales
            const modalTrigger = event.target.closest('[data-bs-toggle="modal"]');
            if (modalTrigger) {
                event.preventDefault();
                const targetModalId = modalTrigger.getAttribute('data-bs-target').replace('#', '');
                window.mostrarModalSeguro(targetModalId);
            }
            
            // Detectar botones que cierran modales
            const closeButton = event.target.closest('[data-bs-dismiss="modal"]');
            if (closeButton) {
                event.preventDefault();
                const modal = closeButton.closest('.modal');
                if (modal) {
                    window.cerrarModalSeguro(modal.id);
                }
            }
        });

        // Monitorear UI bloqueada automáticamente
        setInterval(function() {
            const modalBackdrops = document.querySelectorAll('.modal-backdrop');
            const modalesActivos = document.querySelectorAll('.modal.show');
            
            // Si hay backdrops pero no hay modales activos, limpiar
            if (modalBackdrops.length > 0 && modalesActivos.length === 0) {
                console.log('UI bloqueada detectada - limpiando automáticamente');
                window.limpiarUIBloqueada();
            }
        }, 3000);

        console.log('Sistema de gestión segura de modales inicializado');
    })();
    </script>
</body>
</html>
